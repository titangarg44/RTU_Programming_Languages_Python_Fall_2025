import json
from datetime import datetime

DT_FORMAT = "%Y-%m-%d %H:%M"


def parse_dt(s):
    try:
        return datetime.strptime(s, DT_FORMAT)
    except Exception:
        return None


def validate_and_convert(cols):
    if len(cols) != 6:
        return None, "missing required fields"

    fid, orig, dest, dep_s, arr_s, price_s = [c.strip() for c in cols]
    errors = []

    # Validation rules
    if not (2 <= len(fid) <= 8 and fid.isalnum()):
        errors.append("invalid flight_id")

    if not (len(orig) == 3 and orig.isalpha() and orig.isupper()):
        errors.append("invalid origin")

    if not (len(dest) == 3 and dest.isalpha() and dest.isupper()):
        errors.append("invalid destination")

    dep = parse_dt(dep_s)
    arr = parse_dt(arr_s)
    if dep is None:
        errors.append("invalid departure datetime")
    if arr is None:
        errors.append("invalid arrival datetime")
    if dep and arr and arr <= dep:
        errors.append("arrival before departure")

    try:
        price = float(price_s)
        if price <= 0:
            errors.append("price must be positive")
    except Exception:
        errors.append("invalid price")

    if errors:
        return None, ", ".join(errors)

    return {
        "flight_id": fid,
        "origin": orig,
        "destination": dest,
        "departure_datetime": dep_s,
        "arrival_datetime": arr_s,
        "price": price,
    }, None


def parse_csv_file(lines, valid, errors):
    for i, line in enumerate(lines, start=1):
        if not line.strip():
            continue

        if line.startswith("#"):
            errors.append((i, line, "comment line, ignored for data parsing"))
            continue

        cols = line.split(",")
        obj, err = validate_and_convert(cols)
        if err:
            errors.append((i, line, err))
        else:
            valid.append(obj)


def load_json_db(path):
    return json.loads(path.read_text(encoding="utf-8"))


def match(rec, q):
    # exact fields
    for k in ["flight_id", "origin", "destination"]:
        if k in q and rec[k] != q[k]:
            return False

    # departure >=
    if "departure_datetime" in q:
        if parse_dt(rec["departure_datetime"]) < parse_dt(q["departure_datetime"]):
            return False

    # arrival <=
    if "arrival_datetime" in q:
        if parse_dt(rec["arrival_datetime"]) > parse_dt(q["arrival_datetime"]):
            return False

    # price <=
    if "price" in q:
        if rec["price"] > q["price"]:
            return False

    return True


def run_queries(db, queries):
    if isinstance(queries, dict):
        queries = [queries]

    results = []
    for q in queries:
        matches = [r for r in db if match(r, q)]
        results.append({"query": q, "matches": matches})
    return results
